name: Build & Deploy payment-service

on:
  push:
    branches: [dev, main]

permissions:
  contents: read

concurrency:
  group: payment-service-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    uses: cloudshopt/infrastructure/.github/workflows/build-image.yaml@main
    with:
      prod_branch: main
      image_repository: timib22/cloudshopt-payments-php
      dockerfile: .docker/php/prod.Dockerfile
      docker_context: .
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  deploy:
    needs: build
    uses: cloudshopt/infrastructure/.github/workflows/deploy-helm.yaml@main
    with:
      prod_branch: main

      infra_repo: cloudshopt/infrastructure
      infra_ref: main

      helm_chart_path: helm/payment-service
      values_prod: helm/payment-service/values.yaml
      values_dev: helm/payment-service/values-dev.yaml

      namespace_prod: cloudshopt
      namespace_dev: cloudshopt-dev
      release_prod: payment-service
      release_dev: payment-service-dev

      image_repository: timib22/cloudshopt-payments-php
      image_tag: ${{ needs.build.outputs.image_tag }}

      health_prod: http://app.timotejblazic.eu/api/payments/info
      health_dev: http://app-dev.timotejblazic.eu/api/payments/info

      k8s_secret_name: payment-service-secrets

    secrets:
      KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

      DB_PASSWORD_PROD: ${{ secrets.PROD_DB_PASSWORD }}
      REDIS_PASSWORD_PROD: ${{ secrets.PROD_REDIS_PASSWORD }}
      JWT_SECRET_PROD: ${{ secrets.PROD_JWT_SECRET }}
      ORDER_SERVICE_KEY_PROD: ${{ secrets.PROD_ORDER_SERVICE_KEY }}
      STRIPE_SECRET_KEY_PROD: ${{ secrets.PROD_STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET_PROD: ${{ secrets.PROD_STRIPE_WEBHOOK_SECRET }}

      DB_PASSWORD_DEV: ${{ secrets.DEV_DB_PASSWORD }}
      REDIS_PASSWORD_DEV: ${{ secrets.DEV_REDIS_PASSWORD }}
      JWT_SECRET_DEV: ${{ secrets.DEV_JWT_SECRET }}
      ORDER_SERVICE_KEY_DEV: ${{ secrets.DEV_ORDER_SERVICE_KEY }}
      STRIPE_SECRET_KEY_DEV: ${{ secrets.DEV_STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET_DEV: ${{ secrets.DEV_STRIPE_WEBHOOK_SECRET }}